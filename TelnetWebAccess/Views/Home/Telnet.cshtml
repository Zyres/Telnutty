@{
    ViewBag.Title = "Telnet";
}
<div class="container">
<h2>Telnet</h2>
    <form role="form">
        <div class="form-group">
            <label for="host" class="control-label">Host</label>
            <input type="text" class="form-control" id="host" placeholder="127.0.0.1" value="127.0.0.1">
            <label for="port" class="control-label">Port</label>
            <input type="text" class="form-control" id="port" placeholder="23" value="23">
        </div>
        <input class="btn btn-default" type="button" id="connect" value="Connect" />
    </form>
    <pre class="top-buffer terminal" id="terminal" tabindex="0">
    </pre>
</div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the telnet page and send messages.-->
    <script>
        // Prevent backspace from navigating back in browser
        $(document).unbind('keydown').bind('keydown', function (event) {
            var doPrevent = false;
            if (event.keyCode === 8 || event.keyCode === 9 || event.keyCode == 38) {
                var d = event.srcElement || event.target;
                if ((d.tagName.toUpperCase() === 'INPUT' && (d.type.toUpperCase() === 'TEXT' || d.type.toUpperCase() === 'PASSWORD' || d.type.toUpperCase() === 'FILE' || d.type.toUpperCase() === 'EMAIL'))
                    || d.tagName.toUpperCase() === 'TEXTAREA') {
                    doPrevent = d.readOnly || d.disabled;
                }
                else {
                    doPrevent = true;
                }
            }

            if (doPrevent) {
                event.preventDefault();
            }
        });

        $(function () {
            // Reference the auto-generated proxy for the hub.
            var telnet = $.connection.telnetHub;
            // Create a function that the hub can call back to display messages.
            telnet.client.addKeyCodes = function (keyCodes) {
                var keyCodesLength = keyCodes.length;
                var originalTerminalText = $('#terminal').text();
                var characterCountToDelete = 0;
                var textToAppend = [];
                for (var i = 0; i < keyCodesLength; i++) {
                    if (keyCodes[i] === 13) {
                        // Ignore carriage returns
                    }
                    else if (keyCodes[i] === 255) {
                        // TODO: handle 2-3 byte interpret as command IAC, for now ignore
                        i++;
                        // WILL USE and START USE, ignore 3rd byte
                        if (keyCodes[i] === 251 || keyCodes[i] === 253) {
                            i++;
                            // TODO: handle option negotiations
                        }
                    }
                    else if (keyCodes[i] === 27) {
                        if (keyCodes[i + 1] === 91) {
                            // TODO: handle all color codes

                        }
                    }
                    else if (keyCodes[i] === 8 && keyCodes[i + 1] === 32) {
                        switch (keyCodes[i + 2]) {
                            case 8:
                                characterCountToDelete++;
                                break;
                        }
                        i += 2;
                    } else {
                        textToAppend.push(String.fromCharCode(keyCodes[i]));
                    }
                }
                $('#terminal').text(originalTerminalText.substring(0, originalTerminalText.length - characterCountToDelete) + textToAppend.join(""));

                // Scroll to bottom
                $('#terminal').scrollTop($('#terminal')[0].scrollHeight);
            };
            // Set initial focus to message input box.
            $('#terminal').focus();

            var host = "";
            var port = "";

            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#terminal').keypress(function (event) {
                    // Call the Send method on the hub.
                    telnet.server.sendKeyPress(host, port, event.keyCode);
                });
                $('#terminal').keydown(function (event) {
                    // Call the Send method on the hub.
                    telnet.server.sendKeyDown(host, port, event.keyCode);
                });
                $('#connect').click(function () {
                    host = $('#host').val();
                    port = $('#port').val();
                    telnet.server.connect(host, port);
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}